'use strict';

const logger = require('../util/logger');
const sprintf = require('sprintf');
const headers = 'Previews Code,Quantity,Title,Price,Publisher,Comment\n';
const row = '%s,%d,%s,%s,%s,%s\n';

module.exports = (req, res, next) => {
  let order = headers;

  for (let i = 0; i < req.body.line_items.length; i++) {
    const lineItem = req.body.line_items[i];
    order += sprintf(row, lineItem.previews,
                          lineItem.quantity,
                          lineItem.description,
                          lineItem.price,
                          lineItem.publisher,
                          lineItem.comment);
  }

  order += ",,Total," + req.body.order_total + ",\n";
  order += "\nGenerated by Ace My Order";

  res.setHeader("Content-type", "text/csv");
  res.setHeader("Content-Disposition", "filename=order" + req.body.issue + ".csv");
  res.setHeader("Pragma", "no-cache");
  res.setHeader("Expires", "0");
  res.json(order);
}
